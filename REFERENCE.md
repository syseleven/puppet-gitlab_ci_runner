# Reference
<!-- DO NOT EDIT: This document was generated by Puppet Strings -->

## Table of Contents

**Classes**

_Public Classes_

* [`gitlab_ci_runner`](#gitlab_ci_runner): This module installs and configures Gitlab CI Runners.

_Private Classes_

* `gitlab_ci_runner::config`: Manages the configuration of Gitlab runner
* `gitlab_ci_runner::install`: Manages the package of Gitlab runner
* `gitlab_ci_runner::repo`: Manages the repository for Gitlab runner
* `gitlab_ci_runner::service`: Manages the service of Gitlab runner

**Defined types**

* [`gitlab_ci_runner::runner`](#gitlab_ci_runnerrunner): This configures a Gitlab CI runner.

**Functions**

* [`gitlab_ci_runner::register`](#gitlab_ci_runnerregister): A function that registers a Gitlab runner on a Gitlab instance. Be careful, this will be triggered on noop runs as well!
* [`gitlab_ci_runner::register_to_file`](#gitlab_ci_runnerregister_to_file): A function that registers a Gitlab runner on a Gitlab instance, if it doesn't already exist, _and_ saves the retrived authentication token to
* [`gitlab_ci_runner::to_toml`](#gitlab_ci_runnerto_toml): Convert a data structure and output to TOML.
* [`gitlab_ci_runner::unregister`](#gitlab_ci_runnerunregister): A function that unregisters a Gitlab runner from a Gitlab instance. Be careful, this will be triggered on noop runs as well!

**Data types**

* [`Gitlab_ci_runner::Log_format`](#gitlab_ci_runnerlog_format): Gitlab Runner log format configuration
* [`Gitlab_ci_runner::Log_level`](#gitlab_ci_runnerlog_level): Gitlab Runner log level configuration
* [`Gitlab_ci_runner::Register`](#gitlab_ci_runnerregister): A struct of all possible additionl options for gitlab_ci_runner::register

**Tasks**

* [`register_runner`](#register_runner): Registers a runner on a Gitlab instance.
* [`unregister_runner`](#unregister_runner): Unregisters a runner from a Gitlab instance.

## Classes

### gitlab_ci_runner

This module installs and configures Gitlab CI Runners.

#### Examples

##### Simple runner registration

```puppet
class { 'gitlab_ci_runner':
  runners => {
 	 example_runner => {
 		 'registration-token' => 'gitlab-token',
 		 'url'                => 'https://gitlab.com',
 		 'tag-list'           => 'docker,aws',
 	 },
  },
}
```

#### Parameters

The following parameters are available in the `gitlab_ci_runner` class.

##### `runners`

Data type: `Hash`

Hashkeys are used as $title in runners.pp. The subkeys have to be named as the parameter names from ´gitlab-runner register´ command cause they're later joined to one entire string using 2 hyphen to look like shell command parameters. See ´https://docs.gitlab.com/runner/register/#one-line-registration-command´ for details.

Default value: {}

##### `runner_defaults`

Data type: `Hash`

A hash with defaults which will be later merged with $runners.

Default value: {}

##### `xz_package_name`

Data type: `String`

The name of the 'xz' package. Needed for local docker installations.

##### `concurrent`

Data type: `Optional[Integer]`

Limits how many jobs globally can be run concurrently. The most upper limit of jobs using all defined runners. 0 does not mean unlimited!

Default value: `undef`

##### `log_level`

Data type: `Optional[Gitlab_ci_runner::Log_level]`

Log level (options: debug, info, warn, error, fatal, panic). Note that this setting has lower priority than level set by command line argument --debug, -l or --log-level

Default value: `undef`

##### `log_format`

Data type: `Optional[Gitlab_ci_runner::Log_format]`

Log format (options: runner, text, json). Note that this setting has lower priority than format set by command line argument --log-format

Default value: `undef`

##### `check_interval`

Data type: `Optional[Integer]`

defines the interval length, in seconds, between new jobs check. The default value is 3; if set to 0 or lower, the default value will be used.

Default value: `undef`

##### `sentry_dsn`

Data type: `Optional[String]`

Enable tracking of all system level errors to sentry.

Default value: `undef`

##### `listen_address`

Data type: `Optional[Pattern[/.*:.+/]]`

Address (<host>:<port>) on which the Prometheus metrics HTTP server should be listening.

Default value: `undef`

##### `manage_docker`

Data type: `Boolean`

If docker should be installs (uses the puppetlabs-docker).

Default value: `false`

##### `manage_repo`

Data type: `Boolean`

If the repository should be managed.

Default value: `true`

##### `package_ensure`

Data type: `String`

The package 'ensure' state.

Default value: installed

##### `package_name`

Data type: `String`

The name of the package.

Default value: 'gitlab-runner'

##### `repo_base_url`

Data type: `Stdlib::HTTPUrl`

The base repository url.

Default value: 'https://packages.gitlab.com'

##### `repo_keyserver`

Data type: `Optional[Stdlib::Fqdn]`

The keyserver which should be used to get the repository key.

Default value: `undef`

##### `config_path`

Data type: `String`

The path to the config file of Gitlab runner.

Default value: '/etc/gitlab-runner/config.toml'

## Defined types

### gitlab_ci_runner::runner

This configures a Gitlab CI runner.

#### Examples

##### Add a simple runner

```puppet
gitlab_ci_runner::runner { 'testrunner':
  config               => {
    'url'              => 'https://gitlab.com',
    'token'            => '123456789abcdefgh', # Note this is different from the registration token used by `gitlab-runner register`
    'executor'         => 'shell',
  },
}
```

##### Add a autoscaling runner with DigitalOcean as IaaS

```puppet
gitlab_ci_runner::runner { 'autoscale-runner':
  config => {
   url      => 'https://gitlab.com',
   token    => 'RUNNER_TOKEN', # Note this is different from the registration token used by `gitlab-runner register`
   name     => 'autoscale-runner',
   executor => 'docker+machine',
   limit    => 10,
   docker   => {
     image => 'ruby:2.6',
   },
   machine  => {
     OffPeakPeriods   => [
       '* * 0-9,18-23 * * mon-fri *',
       '* * * * * sat,sun *',
     ],
     OffPeakIdleCount => 1,
     OffPeakIdleTime  => 1200,
     IdleCount        => 5,
     IdleTime         => 600,
     MaxBuilds        => 100,
     MachineName      => 'auto-scale-%s',
     MachineDriver    => 'digitalocean',
     MachineOptions   => [
       'digitalocean-image=coreos-stable',
       'digitalocean-ssh-user=core',
       'digitalocean-access-token=DO_ACCESS_TOKEN',
       'digitalocean-region=nyc2',
       'digitalocean-size=4gb',
       'digitalocean-private-networking',
       'engine-registry-mirror=http://10.11.12.13:12345',
     ],
   },
   cache    => {
     'Type' => 's3',
     s3     => {
       ServerAddress => 's3-eu-west-1.amazonaws.com',
       AccessKey     => 'AMAZON_S3_ACCESS_KEY',
       SecretKey     => 'AMAZON_S3_SECRET_KEY',
       BucketName    => 'runner',
       Insecure      => false,
     },
   },
  },
}
```

#### Parameters

The following parameters are available in the `gitlab_ci_runner::runner` defined type.

##### `config`

Data type: `Hash`

Hash with configuration options.
See https://docs.gitlab.com/runner/configuration/advanced-configuration.html for all possible options.
If you omit the 'name' configuration, we will automatically use the $title of this define class.

## Functions

### gitlab_ci_runner::register

Type: Ruby 4.x API

A function that registers a Gitlab runner on a Gitlab instance. Be careful, this will be triggered on noop runs as well!

#### Examples

##### Using it as a replacement for the Bolt 'register_runner' task

```puppet
puppet apply -e "notice(gitlab_ci_runner::register('https://gitlab.com', 'registration-token'))"
```

#### `gitlab_ci_runner::register(Stdlib::HTTPUrl $url, String[1] $token, Optional[Gitlab_ci_runner::Register] $additional_options)`

A function that registers a Gitlab runner on a Gitlab instance. Be careful, this will be triggered on noop runs as well!

Returns: `Struct[{ id => Integer[1], token => String[1], }]` Returns a hash with the runner id and authentcation token

##### Examples

###### Using it as a replacement for the Bolt 'register_runner' task

```puppet
puppet apply -e "notice(gitlab_ci_runner::register('https://gitlab.com', 'registration-token'))"
```

##### `url`

Data type: `Stdlib::HTTPUrl`

The url to your Gitlab instance. Please only provide the host part (e.g https://gitlab.com)

##### `token`

Data type: `String[1]`

Registration token.

##### `additional_options`

Data type: `Optional[Gitlab_ci_runner::Register]`

A hash with all additional configuration options for that runner

### gitlab_ci_runner::register_to_file

Type: Ruby 4.x API

A function that registers a Gitlab runner on a Gitlab instance, if it doesn't already exist,
_and_ saves the retrived authentication token to a file. This is helpful for Deferred functions.

#### Examples

##### Using it as a Deferred function

```puppet
gitlab_ci_runner::runner { 'testrunner':
  config               => {
    'url'              => 'https://gitlab.com',
    'token'            => Deferred('gitlab_ci_runner::register_runner_to_file', [$config['url'], $config['registration-token'], 'testrunner']) }
    'executor'         => 'shell',
  },
}
```

#### `gitlab_ci_runner::register_to_file(String[1] $url, String[1] $regtoken, String[1] $runner_name, Optional[Hash] $additional_options, Optional[String[1]] $filename)`

A function that registers a Gitlab runner on a Gitlab instance, if it doesn't already exist,
_and_ saves the retrived authentication token to a file. This is helpful for Deferred functions.

Returns: `String[1]` Returns the authentication token

##### Examples

###### Using it as a Deferred function

```puppet
gitlab_ci_runner::runner { 'testrunner':
  config               => {
    'url'              => 'https://gitlab.com',
    'token'            => Deferred('gitlab_ci_runner::register_runner_to_file', [$config['url'], $config['registration-token'], 'testrunner']) }
    'executor'         => 'shell',
  },
}
```

##### `url`

Data type: `String[1]`

The url to your Gitlab instance. Please only provide the host part (e.g https://gitlab.com)

##### `regtoken`

Data type: `String[1]`

Registration token.

##### `runner_name`

Data type: `String[1]`

The name of the runner. Use as identifier for the retrived auth token.

##### `filename`

Data type: `Optional[String[1]]`

The filename where the token should be saved.

##### `additional_options`

Data type: `Optional[Hash]`

A hash with all additional configuration options for that runner

### gitlab_ci_runner::to_toml

Type: Ruby 4.x API

Convert a data structure and output to TOML.

#### Examples

##### How to output TOML to a file

```puppet
file { '/tmp/config.toml':
  ensure  => file,
  content => to_toml($myhash),
}
```

#### `gitlab_ci_runner::to_toml(Hash $data)`

The gitlab_ci_runner::to_toml function.

Returns: `String` Converted data as TOML string

##### Examples

###### How to output TOML to a file

```puppet
file { '/tmp/config.toml':
  ensure  => file,
  content => to_toml($myhash),
}
```

##### `data`

Data type: `Hash`

Data structure which needs to be converted into TOML

### gitlab_ci_runner::unregister

Type: Ruby 4.x API

A function that unregisters a Gitlab runner from a Gitlab instance. Be careful, this will be triggered on noop runs as well!

#### Examples

##### Using it as a replacement for the Bolt 'unregister_runner' task

```puppet
puppet apply -e "notice(gitlab_ci_runner::unregister('https://gitlab.com', 'runner-auth-token'))"
```

#### `gitlab_ci_runner::unregister(Stdlib::HTTPUrl $url, String[1] $token)`

A function that unregisters a Gitlab runner from a Gitlab instance. Be careful, this will be triggered on noop runs as well!

Returns: `Struct[{ status => Enum['success'], }]` Returns a hash with the runner id and authentcation token

##### Examples

###### Using it as a replacement for the Bolt 'unregister_runner' task

```puppet
puppet apply -e "notice(gitlab_ci_runner::unregister('https://gitlab.com', 'runner-auth-token'))"
```

##### `url`

Data type: `Stdlib::HTTPUrl`

The url to your Gitlab instance. Please only provide the host part (e.g https://gitlab.com)

##### `token`

Data type: `String[1]`

Runners authentication token.

## Data types

### Gitlab_ci_runner::Log_format

Gitlab Runner log format configuration

Alias of `Enum['runner', 'text', 'json']`

### Gitlab_ci_runner::Log_level

Gitlab Runner log level configuration

Alias of `Enum['debug', 'info', 'warn', 'error', 'fatal', 'panic']`

### Gitlab_ci_runner::Register

A struct of all possible additionl options for gitlab_ci_runner::register

Alias of `Struct[{
  Optional[description]     => String[1],
  Optional[info]            => Hash[String[1],String[1]],
  Optional[active]          => Boolean,
  Optional[locked]          => Boolean,
  Optional[run_untagged]    => Boolean,
  Optional[tag_list]        => Array[String[1]],
  Optional[access_level]    => Enum['not_protected', 'ref_protected'],
  Optional[maximum_timeout] => Integer,
}]`

## Tasks

### register_runner

Registers a runner on a Gitlab instance.

**Supports noop?** false

#### Parameters

##### `url`

Data type: `String[1]`

The url to your Gitlab instance. Please only provide the host part (e.g https://gitlab.com)

##### `token`

Data type: `String[1]`

Registration token.

##### `description`

Data type: `Optional[String[1]]`

Runners description.

##### `info`

Data type: `Optional[Hash]`

Runners metadata.

##### `active`

Data type: `Optional[Boolean]`

Whether the Runner is active.

##### `locked`

Data type: `Optional[Boolean]`

Whether the Runner should be locked for current project.

##### `run_untagged`

Data type: `Optional[Boolean]`

Whether the Runner should handle untagged jobs.

##### `tag_list`

Data type: `Optional[Array[String[1]]]`

List of Runners tags.

##### `access_level`

Data type: `Optional[Enum['not_protected', 'ref_protected']]`

The access_level of the runner.

##### `maximum_timeout`

Data type: `Optional[Integer[1]]`

Maximum timeout set when this Runner will handle the job.

### unregister_runner

Unregisters a runner from a Gitlab instance.

**Supports noop?** false

#### Parameters

##### `url`

Data type: `String[1]`

The url to your Gitlab instance. Please provide the host part only! (e.g https://gitlab.com)

##### `token`

Data type: `String[1]`

Runners authentication token.

